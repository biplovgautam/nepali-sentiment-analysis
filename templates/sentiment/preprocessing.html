{% extends 'sentiment/base.html' %}

{% block title %}Text Preprocessing - Financial Sentiment Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-cogs"></i> Text Preprocessing</h1>
    <p class="lead">Configure and apply text preprocessing steps to prepare your data for training.</p>
</div>

<div class="row">
    <!-- Current Dataset Info -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0"><i class="fas fa-database"></i> Filtered Dataset</h5>
            </div>
            <div class="card-body">
                {% if filtered_dataset_info %}
                    <div class="metric-card">
                        <div class="metric-value">{{ filtered_dataset_info.shape.0 }}</div>
                        <div class="metric-label">Total Samples</div>
                    </div>
                    
                    <h6 class="mt-3">Class Distribution:</h6>
                    <ul class="list-unstyled">
                        {% for class, count in filtered_dataset_info.class_distribution.items %}
                        <li class="mb-1">
                            <span class="badge bg-primary">{{ class }}</span>
                            <span class="ms-2">{{ count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No filtered dataset information available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Preprocessing Configuration -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-sliders-h"></i> Preprocessing Configuration</h5>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Boolean Options -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-check-square text-success"></i> Text Cleaning Options</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.remove_stopwords }}
                                        <label class="form-check-label" for="{{ form.remove_stopwords.id_for_label }}">
                                            {{ form.remove_stopwords.label }}
                                        </label>
                                        <div class="form-text">{{ form.remove_stopwords.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.remove_punctuation }}
                                        <label class="form-check-label" for="{{ form.remove_punctuation.id_for_label }}">
                                            {{ form.remove_punctuation.label }}
                                        </label>
                                        <div class="form-text">{{ form.remove_punctuation.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.remove_numbers }}
                                        <label class="form-check-label" for="{{ form.remove_numbers.id_for_label }}">
                                            {{ form.remove_numbers.label }}
                                        </label>
                                        <div class="form-text">{{ form.remove_numbers.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.normalize_tickers }}
                                        <label class="form-check-label" for="{{ form.normalize_tickers.id_for_label }}">
                                            {{ form.normalize_tickers.label }}
                                        </label>
                                        <div class="form-text">{{ form.normalize_tickers.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Length Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-ruler text-info"></i> Text Length Filters</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.min_length.id_for_label }}" class="form-label">
                                        {{ form.min_length.label }}
                                    </label>
                                    {{ form.min_length }}
                                    <div class="form-text">{{ form.min_length.help_text }}</div>
                                    {% if form.min_length.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.min_length.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.max_length.id_for_label }}" class="form-label">
                                        {{ form.max_length.label }}
                                    </label>
                                    {{ form.max_length }}
                                    <div class="form-text">{{ form.max_length.help_text }}</div>
                                    {% if form.max_length.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.max_length.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'dataset_filter' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Filter
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> Apply Preprocessing
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preprocessing Information -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Preprocessing Steps Explained</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-broom text-warning"></i> Text Cleaning:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Remove Stopwords:</strong> Eliminates common words like 'the', 'and', 'or'</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Remove Punctuation:</strong> Strips punctuation marks and special characters</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Remove Numbers:</strong> Removes numeric characters from text</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Normalize Tickers:</strong> Converts $AAPL, $MSFT to TICKER placeholder</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-filter text-success"></i> Length Filtering:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Min Length:</strong> Removes texts shorter than specified length</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Max Length:</strong> Truncates texts longer than specified length</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Quality Control:</strong> Ensures consistent text quality for training</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> <strong>Performance:</strong> Optimizes training speed and memory usage</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb"></i> 
                    <strong>Output:</strong> After preprocessing, a <code>train_ready.csv</code> file will be created in the data directory with cleaned and normalized text data ready for model training.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Length validation
    document.getElementById('{{ form.min_length.id_for_label }}').addEventListener('change', function() {
        const minLength = parseInt(this.value);
        const maxLengthInput = document.getElementById('{{ form.max_length.id_for_label }}');
        const maxLength = parseInt(maxLengthInput.value);
        
        if (minLength >= maxLength) {
            maxLengthInput.value = minLength + 10;
        }
    });

    document.getElementById('{{ form.max_length.id_for_label }}').addEventListener('change', function() {
        const maxLength = parseInt(this.value);
        const minLengthInput = document.getElementById('{{ form.min_length.id_for_label }}');
        const minLength = parseInt(minLengthInput.value);
        
        if (maxLength <= minLength) {
            minLengthInput.value = Math.max(1, maxLength - 10);
        }
    });
</script>
{% endblock %}
